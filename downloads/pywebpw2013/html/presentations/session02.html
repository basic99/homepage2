<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Python Web Programming</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Python Web Programming</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Python Web Programming</h1>

<img alt="img/protocol.png" class="align-left" src="img/protocol.png" style="width: 45%;" />
<p>Session 2: Web Protocols</p>
<p class="intro-blurb">Wherein we learn about the languages that machines speak to each other</p>

</div>
<div class="slide" id="what-is-a-protocol">
<h1>What is a Protocol?</h1>
<p class="incremental center">a set of rules or conventions</p>
<p class="incremental center">governing communications</p>
</div>
<div class="slide" id="protocols-irl">
<h1>Protocols IRL</h1>
<p>Life has lots of sets of rules for how to do things.</p>
<ul class="incremental simple">
<li>What do you say when you get on the elevator?</li>
<li>What do you do on a first date?</li>
<li>What do you wear to a job interview?</li>
<li>What do (and don't) you talk about at a dinner party?</li>
<li>...?</li>
</ul>
</div>
<div class="slide" id="id1">
<h1>Protocols IRL</h1>
<img alt="img/icup.png" class="align-center" src="img/icup.png" style="width: 58%;" />
<p class="image-credit"><a class="reference external" href="http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/">http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/</a></p>
</div>
<div class="slide" id="protocols-in-computers">
<h1>Protocols In Computers</h1>
<p>Digital life has lots of rules too:</p>
<ul class="incremental simple">
<li>how to say hello</li>
<li>how to identify yourself</li>
<li>how to ask for information</li>
<li>how to provide answers</li>
<li>how to say goodbye</li>
</ul>
</div>
<div class="slide" id="real-protocol-examples">
<h1>Real Protocol Examples</h1>
<p class="big-centered">What does this look like in practice?</p>
</div>
<div class="slide" id="id2">
<h1>Real Protocol Examples</h1>
<ul class="incremental simple">
<li>SMTP (Simple Message Transfer Protocol)
<a class="reference external" href="http://tools.ietf.org/html/rfc5321#appendix-D">http://tools.ietf.org/html/rfc5321#appendix-D</a></li>
<li>POP3 (Post Office Protocol)
<a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">http://www.faqs.org/docs/artu/ch05s03.html</a></li>
<li>IMAP (Internet Message Access Protocol)
<a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">http://www.faqs.org/docs/artu/ch05s03.html</a></li>
<li>HTTP (Hyper-Text Transfer Protocol)
<a class="reference external" href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol</a></li>
</ul>
</div>
<div class="slide" id="what-does-smtp-look-like">
<h1>What does SMTP look like?</h1>
<p>SMTP (Say hello and identify yourself):</p>
<pre class="literal-block">
S: 220 foo.com Simple Mail Transfer Service Ready
C: EHLO bar.com
S: 250-foo.com greets bar.com
S: 250-8BITMIME
S: 250-SIZE
S: 250-DSN
S: 250 HELP
</pre>
</div>
<div class="slide" id="id3">
<h1>What does SMTP look like?</h1>
<p>SMTP (Ask for information, provide answers):</p>
<pre class="literal-block">
C: MAIL FROM:&lt;Smith&#64;bar.com&gt;
S: 250 OK
C: RCPT TO:&lt;Jones&#64;foo.com&gt;
S: 250 OK
C: RCPT TO:&lt;Green&#64;foo.com&gt;
S: 550 No such user here
C: DATA
S: 354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;
C: Blah blah blah...
C: ...etc. etc. etc.
C: .
S: 250 OK
</pre>
</div>
<div class="slide" id="id4">
<h1>What does SMTP look like?</h1>
<p>SMTP (Say goodbye):</p>
<pre class="literal-block">
C: QUIT
S: 221 foo.com Service closing transmission channel
</pre>
</div>
<div class="slide" id="smtp-characteristics">
<h1>SMTP Characteristics</h1>
<ul class="incremental simple">
<li>Interaction consists of commands and replies</li>
<li>Each command or reply is <em>one line</em> terminated by &lt;CRLF&gt;</li>
<li>The exception is message payload, terminated by &lt;CRLF&gt;.&lt;CRLF&gt;</li>
<li>Each command has a <em>verb</em> and one or more <em>arguments</em></li>
<li>Each reply has a formal <em>code</em> and an informal <em>explanation</em></li>
</ul>
</div>
<div class="slide" id="what-does-pop3-look-like">
<h1>What does POP3 look like?</h1>
<p>POP3 (Say hello and identify yourself):</p>
<pre class="literal-block">
C: &lt;client connects to service port 110&gt;
S: +OK POP3 server ready &lt;1896.6971&#64;mailgate.dobbs.org&gt;
C: USER bob
S: +OK bob
C: PASS redqueen
S: +OK bob's maildrop has 2 messages (320 octets)
</pre>
</div>
<div class="slide" id="id5">
<h1>What does POP3 look like?</h1>
<p>POP3 (Ask for information, provide answers):</p>
<pre class="literal-block">
C: STAT
S: +OK 2 320
C: LIST
S: +OK 1 messages (120 octets)
S: 1 120
S: .
</pre>
</div>
<div class="slide" id="id6">
<h1>What does POP3 look like?</h1>
<p>POP3 (Ask for information, provide answers):</p>
<pre class="literal-block">
C: RETR 1
S: +OK 120 octets
S: &lt;server sends the text of message 1&gt;
S: .
C: DELE 1
S: +OK message 1 deleted
</pre>
</div>
<div class="slide" id="id7">
<h1>What does POP3 look like?</h1>
<p>POP3 (Say goodbye):</p>
<pre class="literal-block">
C: QUIT
S: +OK dewey POP3 server signing off (maildrop empty)
C: &lt;client hangs up&gt;
</pre>
</div>
<div class="slide" id="pop3-characteristics">
<h1>POP3 Characteristics</h1>
<ul class="incremental simple">
<li>Interaction consists of commands and replies</li>
<li>Each command or reply is <em>one line</em> terminated by &lt;CRLF&gt;</li>
<li>The exception is message payload, terminated by &lt;CRLF&gt;.&lt;CRLF&gt;</li>
<li>Each command has a <em>verb</em> and one or more <em>arguments</em></li>
<li>Each reply has a formal <em>code</em> and an informal <em>explanation</em></li>
</ul>
<p class="incremental">The codes don't really look the same, though, do they?</p>
</div>
<div class="slide" id="one-other-difference">
<h1>One Other Difference</h1>
<p>The exception to the one-line-per-message rule is <em>payload</em></p>
<p class="incremental">In both SMTP and POP3 this is terminated by &lt;CRLF&gt;.&lt;CRLF&gt;</p>
<p class="incremental">In SMTP, the <em>client</em> has this ability</p>
<p class="incremental">But in POP3, it belongs to the <em>server</em>.  Why?</p>
</div>
<div class="slide" id="what-does-imap-look-like">
<h1>What does IMAP look like?</h1>
<p>IMAP (Say hello and identify yourself):</p>
<pre class="literal-block">
C: &lt;client connects to service port 143&gt;
S: * OK example.com IMAP4rev1 v12.264 server ready
C: A0001 USER &quot;frobozz&quot; &quot;xyzzy&quot;
S: * OK User frobozz authenticated
</pre>
</div>
<div class="slide" id="id8">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [connect to an inbox]):</p>
<pre class="literal-block">
C: A0002 SELECT INBOX
S: * 1 EXISTS
S: * 1 RECENT
S: * FLAGS (\Answered \Flagged \Deleted \Draft \Seen)
S: * OK [UNSEEN 1] first unseen message in /var/spool/mail/esr
S: A0002 OK [READ-WRITE] SELECT completed
</pre>
</div>
<div class="slide" id="id9">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get message sizes]):</p>
<pre class="literal-block">
C: A0003 FETCH 1 RFC822.SIZE
S: * 1 FETCH (RFC822.SIZE 2545)
S: A0003 OK FETCH completed
</pre>
</div>
<div class="slide" id="id10">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get first message header]):</p>
<pre class="literal-block">
C: A0004 FETCH 1 BODY[HEADER]
S: * 1 FETCH (RFC822.HEADER {1425}
&lt;server sends 1425 octets of message payload&gt;
S: )
S: A0004 OK FETCH completed
</pre>
</div>
<div class="slide" id="id11">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get first message body]):</p>
<pre class="literal-block">
C: A0005 FETCH 1 BODY[TEXT]
S: * 1 FETCH (BODY[TEXT] {1120}
&lt;server sends 1120 octets of message payload&gt;
S: )
S: * 1 FETCH (FLAGS (\Recent \Seen))
S: A0005 OK FETCH completed
</pre>
</div>
<div class="slide" id="id12">
<h1>What does IMAP look like?</h1>
<p>IMAP (Say goodbye):</p>
<pre class="literal-block">
C: A0006 LOGOUT
S: * BYE example.com IMAP4rev1 server terminating connection
S: A0006 OK LOGOUT completed
C: &lt;client hangs up&gt;
</pre>
</div>
<div class="slide" id="imap-characteristics">
<h1>IMAP Characteristics</h1>
<ul class="incremental simple">
<li>Interaction consists of commands and replies</li>
<li>Each command or reply is <em>one line</em> terminated by &lt;CRLF&gt;</li>
<li>Each command has a <em>verb</em> and one or more <em>arguments</em></li>
<li>Each reply has a formal <em>code</em> and an informal <em>explanation</em></li>
</ul>
</div>
<div class="incremental slide" id="imap-differences">
<h1>IMAP Differences</h1>
<ul class="incremental simple">
<li>Commands and replies are prefixed by 'sequence identifier'</li>
<li>Payloads are prefixed by message size, rather than terminated by reserved
sequence</li>
</ul>
<p class="incremental">Compared with POP3, what do these differences suggest?</p>
</div>
<div class="slide" id="protocols-in-python">
<h1>Protocols in Python</h1>
<p class="big-centered">Let's try this out for ourselves!</p>
</div>
<div class="slide" id="id13">
<h1>Protocols in Python</h1>
<p class="big-centered">Fire up your python interpreters and prepare to type.</p>
</div>
<div class="slide" id="imap-in-python">
<h1>IMAP in Python</h1>
<p>Begin by importing the <tt class="docutils literal">imaplib</tt> module from the Python Standard Library:</p>
<pre class="literal-block">
&gt;&gt;&gt; import imaplib
&gt;&gt;&gt; dir(imaplib)
['AllowedVersions', 'CRLF', 'Commands',
 'Continuation', 'Debug', 'Flags', 'IMAP4',
 'IMAP4_PORT', 'IMAP4_SSL', 'IMAP4_SSL_PORT',
 ...
 'socket', 'ssl', 'sys', 'time']
&gt;&gt;&gt; imaplib.Debug = 4
</pre>
<p class="incremental">Setting <tt class="docutils literal">imap.Debug</tt> shows us what is sent and received</p>
</div>
<div class="slide" id="id14">
<h1>IMAP in Python</h1>
<p>I've prepared a server for us to use, we'll need to set up a client to speak
to it. Our server requires SSL for connecting to IMAP servers, so let's
initialize an IMAP4_SSL client and authenticate:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn = imaplib.IMAP4_SSL('mail.webfaction.com')
  57:04.83 imaplib version 2.58
  57:04.83 new IMAP4 connection, tag=FNHG
  ...
&gt;&gt;&gt; conn.login(username, password)
  12:16.50 &gt; IMAD1 LOGIN username password
  12:18.52 &lt; IMAD1 OK Logged in.
('OK', ['Logged in.'])
</pre>
</div>
<div class="slide" id="id15">
<h1>IMAP in Python</h1>
<p>We can start by listing the mailboxes we have on the server:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.list()
  00:41.91 &gt; FNHG3 LIST &quot;&quot; *
  00:41.99 &lt; * LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;
  00:41.99 &lt; FNHG3 OK List completed.
('OK', ['(\\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;'])
</pre>
</div>
<div class="slide" id="id16">
<h1>IMAP in Python</h1>
<p>To interact with our email, we must select a mailbox from the list we received
earlier:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.select('INBOX')
  00:00.47 &gt; FNHG2 SELECT INBOX
  00:00.56 &lt; * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
  00:00.56 &lt; * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
  00:00.56 &lt; * 2 EXISTS
  00:00.57 &lt; * 0 RECENT
  00:00.57 &lt; * OK [UNSEEN 2] First unseen.
  00:00.57 &lt; * OK [UIDVALIDITY 1357449499] UIDs valid
  00:00.57 &lt; * OK [UIDNEXT 3] Predicted next UID
  00:00.57 &lt; FNHG2 OK [READ-WRITE] Select completed.
('OK', ['2'])
</pre>
</div>
<div class="slide" id="id17">
<h1>IMAP in Python</h1>
<p>We can search our selected mailbox for messages matching one or more criteria.
The return value is a string list of the UIDs of messages that match our
search:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.search(None, '(FROM &quot;cris&quot;)')
  18:25.41 &gt; FNHG5 SEARCH (FROM &quot;cris&quot;)
  18:25.54 &lt; * SEARCH 1
  18:25.54 &lt; FNHG5 OK Search completed.
('OK', ['1'])
&gt;&gt;&gt;
</pre>
</div>
<div class="slide" id="id18">
<h1>IMAP in Python</h1>
<p>Once we've found a message we want to look at, we can use the <tt class="docutils literal">fetch</tt>
command to read it from the server. IMAP allows fetching each part of
a message independently:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.fetch('1', '(BODY[HEADER])')
...
&gt;&gt;&gt; conn.fetch('1', '(BODY[TEXT])')
...
&gt;&gt;&gt; conn.fetch('1', '(FLAGS)')
</pre>
</div>
<div class="slide" id="python-means-batteries-included">
<h1>Python Means Batteries Included</h1>
<p>So we can download an entire message and then make a Python email message
object</p>
<pre class="small literal-block">
&gt;&gt;&gt; import email
&gt;&gt;&gt; typ, data = conn.fetch('1', '(RFC822)')
  28:08.40 &gt; FNHG8 FETCH 1 (RFC822)
  ...
</pre>
<p>Parse the returned data to get to the actual message</p>
<pre class="small literal-block">
&gt;&gt;&gt; for part in data:
...   if isinstance(part, tuple):
...     msg = email.message_from_string(part[1])
...
&gt;&gt;&gt;
</pre>
</div>
<div class="slide" id="id19">
<h1>IMAP in Python</h1>
<p>Once we have that, we can play with the resulting email object:</p>
<pre class="small literal-block">
&gt;&gt;&gt; msg.keys()
['Return-Path', 'X-Original-To', 'Delivered-To', 'Received',
 ...
 'To', 'Mime-Version', 'X-Mailer']
&gt;&gt;&gt; msg['To']
'demo&#64;crisewing.com'
&gt;&gt;&gt; print msg.get_payload()
If you are reading this email, ...
</pre>
<p class="incremental center"><strong>Neat, huh?</strong></p>
</div>
<div class="slide" id="what-have-we-learned">
<h1>What Have We Learned?</h1>
<ul class="incremental simple">
<li>Protocols are just a set of rules for how to communicate</li>
<li>Protocols tell us how to parse and delimit messages</li>
<li>Protocols tell us what messages are valid</li>
<li>If we properly format request messages to a server, we can get response
messages</li>
<li>Python supports a number of these protocols</li>
<li>So we don't have to remember how to format the commands ourselves</li>
</ul>
<p class="incremental">But in every case we've seen, we could do the same thing with a socket and
some strings</p>
</div>
<div class="slide" id="break-time">
<h1>Break Time</h1>
<p>Let's take a few minutes here to clear our heads.</p>
<p class="incremental">See you back here in 10 minutes.</p>
</div>
<div class="slide" id="http">
<h1>HTTP</h1>
<p class="big-centered">HTTP is no different</p>
</div>
<div class="slide" id="id20">
<h1>HTTP</h1>
<p>HTTP is also message-centered, with two-way communications:</p>
<ul class="incremental simple">
<li>Requests (Asking for information)</li>
<li>Responses (Providing answers)</li>
</ul>
</div>
<div class="slide" id="what-does-http-look-like">
<h1>What does HTTP look like?</h1>
<p>HTTP (Ask for information):</p>
<pre class="literal-block">
GET /index.html HTTP/1.1
Host: www.example.com
&lt;CRLF&gt;
</pre>
</div>
<div class="slide" id="id21">
<h1>What does HTTP look like?</h1>
<p>HTTP (Provide answers):</p>
<pre class="literal-block">
HTTP/1.1 200 OK
Date: Mon, 23 May 2005 22:38:34 GMT
Server: Apache/1.3.3.7 (Unix) (Red-Hat/Linux)
Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT
Etag: &quot;3f80f-1b6-3e1cb03b&quot;
Accept-Ranges:  none
Content-Length: 438
Connection: close
Content-Type: text/html; charset=UTF-8
&lt;CRLF&gt;
&lt;438 bytes of content&gt;
</pre>
</div>
<div class="slide" id="http-req-resp-format">
<h1>HTTP Req/Resp Format</h1>
<p>Both share a common basic format:</p>
<ul class="incremental simple">
<li>Line separators are &lt;CRLF&gt; (familiar, no?)</li>
<li>An required initial line (a command or a response code)</li>
<li>A (mostly) optional set of headers, one per line</li>
<li>A blank line</li>
<li>An optional body</li>
</ul>
</div>
<div class="slide" id="http-in-real-life">
<h1>HTTP In Real Life</h1>
<p>Let's investigate the HTTP protocol a bit in real life.</p>
<p class="incremental">We'll do so by building a simplified HTTP server, one step at a time.</p>
<p class="incremental">We'll bootstrap ourselves by using the <tt class="docutils literal">echo_server.py</tt> file we created
earlier.</p>
<p class="incremental">Make a copy of that file now.  Call it <tt class="docutils literal">http_server_1.py</tt>.  Open it in your
text editors.</p>
</div>
<div class="slide" id="viewing-an-http-request">
<h1>Viewing an HTTP Request</h1>
<p>In a terminal, start your server running, like so:</p>
<pre class="literal-block">
$ python http_server_1.py
making a server on 127.0.0.1:10000
waiting for a connection
</pre>
<p class="incremental">This time, instead of using your echo client to make a connection, let's use
a web browser</p>
<p class="incremental">Point your favorite browser at <tt class="docutils literal"><span class="pre">http://localhost:10000</span></tt></p>
</div>
<div class="slide" id="a-bad-interaction">
<h1>A Bad Interaction</h1>
<p>First, look at the printed output from your echo server.</p>
<p class="incremental">Second, note that your browser is still waiting to finish loading the page</p>
<p class="incremental">Moreover, your server should also be hung, waiting for more from the 'client'</p>
<p class="incremental">This is because we are not yet following the right protocol.</p>
</div>
<div class="slide" id="echoing-a-request">
<h1>Echoing A Request</h1>
<p>Kill your server with <tt class="docutils literal"><span class="pre">ctrl-c</span></tt> (the keyboard interrupt) and you should see
some printed content:</p>
<pre class="small incremental literal-block">
GET / HTTP/1.1
Host: localhost:10000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:22.0) Gecko/20100101 Firefox/22.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
DNT: 1
Cookie: __utma=111872281.383966302.1364503233.1364503233.1364503233.1; __utmz=111872281.1364503233.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); csrftoken=uiqj579iGRbReBHmJQNTH8PFfAz2qRJS
Connection: keep-alive
Cache-Control: max-age=0
</pre>
<p class="incremental small">Your results will vary from mine.</p>
</div>
<div class="slide" id="http-debugging">
<h1>HTTP Debugging</h1>
<p>When working on applications, it's nice to be able to see all this going back
and forth.  There are several apps that can help with this:</p>
<ul class="simple">
<li>windows: <a class="reference external" href="http://www.fiddler2.com/fiddler2/">http://www.fiddler2.com/fiddler2/</a></li>
<li>firefox: <a class="reference external" href="http://getfirebug.com/">http://getfirebug.com/</a></li>
<li>safari: built in</li>
<li>chrome: built in</li>
<li>IE (7.0+): built in</li>
</ul>
<p class="incremental">These tools can show you both request and response, headers and all. Very
useful.</p>
</div>
<div class="slide" id="http-requests">
<h1>HTTP Requests</h1>
<p>In HTTP 1.0, the only required line in an HTTP request is this:</p>
<pre class="literal-block">
GET /path/to/index.html HTTP/1.0
&lt;CRLF&gt;
</pre>
<p class="incremental">As virtual hosting grew more common, that was not enough, so HTTP 1.1 adds a
single required <em>header</em>, <strong>Host</strong>:</p>
<pre class="incremental literal-block">
GET /path/to/index.html HTTP/1.1
Host: www.mysite1.com:80
&lt;CRLF&gt;
</pre>
</div>
<div class="slide" id="http-responses">
<h1>HTTP Responses</h1>
<p>In both HTTP 1.0 and 1.1, a proper response consists of an intial line,
followed by optional headers, a single blank line, and then optionally a
response body:</p>
<pre class="literal-block">
HTTP/1.1 200 OK
Content-Type: text/plain
&lt;CRLF&gt;
this is a pretty minimal response
</pre>
<p class="incremental">Let's update our server to return such a response.</p>
</div>
<div class="slide" id="basic-http-protocol">
<h1>Basic HTTP Protocol</h1>
<p>Begin by implementing a new function in your <tt class="docutils literal">http_server_1.py</tt> script called
<cite>response_ok</cite>.</p>
<p class="incremental">It can be super-simple for now.  We'll improve it later.</p>
<p class="incremental">It needs to return our minimal response from above:</p>
<pre class="small incremental literal-block">
HTTP/1.1 200 OK
Content-Type: text/plain
&lt;CRLF&gt;
this is a pretty minimal response
</pre>
</div>
<div class="slide" id="my-solution">
<h1>My Solution</h1>
<pre class="code python incremental literal-block">
<span class="k">def</span> <span class="nf">response_ok</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;returns a basic HTTP response&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Content-Type: text/plain&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;this is a pretty minimal response&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="server-modifications">
<h1>Server Modifications</h1>
<p>Next, we need to rebuild the server loop from our echo server for it's new
purpose:</p>
<p class="incremental">It should be able to return a response built by our function when a request
is finished</p>
<p class="incremental">We could also bump up the buffer size to something more reasonable for HTTP
traffic, say 1024</p>
</div>
<div class="slide" id="id22">
<h1>My Solution</h1>
<pre class="code python incremental small literal-block">
<span class="c"># ...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'waiting for a connection'</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c"># blocking</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'connection - </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">addr</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'sending response'</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">response_ok</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c"># ...</span>
</pre>
</div>
<div class="slide" id="test-your-work">
<h1>Test Your Work</h1>
<p>Once you've got that set, restart your server:</p>
<pre class="literal-block">
$ python http_server_1.py
</pre>
<p class="incremental">reload your browser pointing to <tt class="docutils literal"><span class="pre">http://localhost:10000</span></tt> and watch the magic!</p>
</div>
<div class="slide" id="parts-of-a-request">
<h1>Parts of a Request</h1>
<p>Every HTTP request <strong>must</strong> begin with a single line, broken by whitespace into
three parts:</p>
<pre class="literal-block">
GET /path/to/index.html HTTP/1.1
</pre>
<p class="incremental">The three parts are the <em>method</em>, the <em>URI</em>, and the <em>protocol</em></p>
<p class="incremental">Let's look at each in turn.</p>
</div>
<div class="slide" id="http-methods">
<h1>HTTP Methods</h1>
<p><strong>GET</strong> <tt class="docutils literal">/path/to/index.html HTTP/1.1</tt></p>
<ul class="incremental">
<li><p class="first">Every HTTP request must start with a <em>method</em></p>
</li>
<li><p class="first">There are four main HTTP methods:</p>
<blockquote>
<ul class="incremental simple">
<li>GET</li>
<li>POST</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</blockquote>
</li>
</ul>
<ul class="incremental simple">
<li>There are others, notably HEAD, but you won't see them too much</li>
</ul>
</div>
<div class="slide" id="id23">
<h1>HTTP Methods</h1>
<p>These four methods are mapped to the four basic steps (<em>CRUD</em>) of persistent
storage:</p>
<ul class="incremental simple">
<li>POST = Create</li>
<li>GET = Read</li>
<li>PUT = Update</li>
<li>DELETE = Delete</li>
</ul>
</div>
<div class="slide" id="methods-safe-unsafe">
<h1>Methods: Safe &lt;--&gt; Unsafe</h1>
<p>HTTP methods can be categorized as <strong>safe</strong> or <strong>unsafe</strong>, based on whether
they might change something on the server:</p>
<ul class="incremental">
<li><dl class="first docutils">
<dt>Safe HTTP Methods</dt>
<dd><ul class="first last simple">
<li>GET</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Unsafe HTTP Methods</dt>
<dd><ul class="first last simple">
<li>POST</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p class="incremental">This is a <em>normative</em> distinction, which is to say <strong>be careful</strong></p>
</div>
<div class="slide" id="methods-idempoent">
<h1>Methods: Idempoent &lt;--&gt; ???</h1>
<p>HTTP methods can be categorized as <strong>idempotent</strong>, based on whether a given
request will always have the same result:</p>
<ul class="incremental">
<li><dl class="first docutils">
<dt>Idempotent HTTP Methods</dt>
<dd><ul class="first last simple">
<li>GET</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Non-Idempotent HTTP Methods</dt>
<dd><ul class="first last simple">
<li>POST</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p class="incremental">Again, <em>normative</em>. The developer is responsible for ensuring that it is true.</p>
</div>
<div class="slide" id="http-method-handling">
<h1>HTTP Method Handling</h1>
<p>Let's keep things simple, our server will only respond to <em>GET</em> requests.</p>
<p class="incremental">We need to create a function that parses a request and determines if we can
respond to it: <tt class="docutils literal">parse_request</tt>.</p>
<p class="incremental">If the request method is not <em>GET</em>, our method should raise an error</p>
<p class="incremental">Remember, although a request is more than one line long, all we care about
here is the first line</p>
</div>
<div class="slide" id="id24">
<h1>My Solution</h1>
<pre class="code python incremental literal-block">
<span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">first_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;We only accept GET&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'request is okay'</span>
</pre>
</div>
<div class="slide" id="update-the-server">
<h1>Update the Server</h1>
<p>We'll also need to update the server code. It should</p>
<ul class="incremental simple">
<li>save the request as it comes in</li>
<li>check the request using our new function</li>
<li>send an OK response if things go well</li>
</ul>
</div>
<div class="slide" id="id25">
<h1>My Solution</h1>
<pre class="code python incremental small literal-block">
<span class="c"># ...</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c"># blocking</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'connection - </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">addr</span>
    <span class="n">request</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'sending response'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_ok</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c"># ...</span>
</pre>
</div>
<div class="slide" id="id26">
<h1>Test Your Work</h1>
<p>Quit and restart your server, now that you've updated the code.</p>
<p class="incremental">Reload your browser.  It should work fine.</p>
<p class="incremental">We can use the <tt class="docutils literal">echo_client.py</tt> script from yesterday to test our error
condition.  In a second terminal window run the script like so:</p>
<pre class="incremental literal-block">
$ python echo_client.py &quot;POST / HTTP/1.0\r\n\r\n&quot;
</pre>
<p class="incremental">You'll have to quit the client pretty quickly with <tt class="docutils literal"><span class="pre">ctrl-c</span></tt></p>
</div>
<div class="slide" id="error-responses">
<h1>Error Responses</h1>
<p>Okay, so the outcome there was pretty ugly. The client went off the rails, and
our server has terminated as well.</p>
<p class="incremental">The HTTP protocol allows us to handle errors like this more gracefully.</p>
<p class="incremental center"><strong>Enter the Response Code</strong></p>
</div>
<div class="slide" id="http-response-codes">
<h1>HTTP Response Codes</h1>
<p><tt class="docutils literal">HTTP/1.1</tt> <strong>200 OK</strong></p>
<p>All HTTP responses must include a <strong>response code</strong> indicating the outcome of
the request.</p>
<ul class="incremental simple">
<li>1xx (HTTP 1.1 only) - Informational message</li>
<li>2xx - Success of some kind</li>
<li>3xx - Redirection of some kind</li>
<li>4xx - Client Error of some kind</li>
<li>5xx - Server Error of some kind</li>
</ul>
<p class="incremental">The text bit makes the code more human-readable</p>
</div>
<div class="slide" id="common-response-codes">
<h1>Common Response Codes</h1>
<p>There are certain HTTP response codes you are likely to see (and use) most
often:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">200 OK</tt> - Everything is good</li>
<li><tt class="docutils literal">301 Moved Permanently</tt> - You should update your link</li>
<li><tt class="docutils literal">304 Not Modified</tt> - You should load this from cache</li>
<li><tt class="docutils literal">404 Not Found</tt> - You've asked for something that doesn't exist</li>
<li><tt class="docutils literal">500 Internal Server Error</tt> - Something bad happened</li>
</ul>
<p class="incremental">Do not be afraid to use other, less common codes in building good apps. There
are a lot of them for a reason. See
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</a></p>
</div>
<div class="slide" id="handling-our-error">
<h1>Handling our Error</h1>
<p>Luckily, there's an error code that is tailor-made for this situation.</p>
<p class="incremental">The client has made a request using a method we do not support</p>
<p class="incremental"><tt class="docutils literal">405 Method Not Allowed</tt></p>
<p class="incremental">Let's add a new function that returns this error code. It should be called
<tt class="docutils literal">response_method_not_allowed</tt></p>
</div>
<div class="slide" id="id27">
<h1>My Solution</h1>
<pre class="code python incremental literal-block">
<span class="k">def</span> <span class="nf">response_method_not_allowed</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;returns a 405 Method Not Allowed response&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 405 Method Not Allowed&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="server-updates">
<h1>Server Updates</h1>
<p>Again, we'll need to update the server to handle this error condition
correctly.  It should</p>
<ul class="incremental simple">
<li>catch the exception raised by the <tt class="docutils literal">parse_request</tt> function</li>
<li>return our new error response as a result</li>
<li>if no exception is raised, then return the OK response</li>
</ul>
</div>
<div class="slide" id="id28">
<h1>My Solution</h1>
<pre class="code python incremental small literal-block">
<span class="c"># ...</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">break</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_method_not_allowed</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_ok</span><span class="p">()</span>

<span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'sending response'</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="c"># ...</span>
</pre>
</div>
<div class="slide" id="id29">
<h1>Test Your Work</h1>
<p>Start your server (or restart it if by some miracle it's still going).</p>
<p class="incremental">Then test this out by using the <tt class="docutils literal">echo_client.py</tt> script again:</p>
<pre class="incremental literal-block">
$ python echo_client.py &quot;POST / HTTP/1.1\r\n\r\n&quot;
connecting to localhost port 10000
sending &quot;POST / HTTP/1.1\r\n\r\n&quot;
received &quot;HTTP/1.1 405 Met&quot;
received &quot;hod Not Allowed
closing socket
</pre>
</div>
<div class="slide" id="http-resources">
<h1>HTTP - Resources</h1>
<p>We've got a very simple server that accepts a request and sends a response.
But what happens if we make a different request?</p>
<div class="incremental container">
<p>In your web browser, enter the following URL:</p>
<pre class="literal-block">
http://localhost:10000/page
</pre>
</div>
<div class="incremental container">
<p>What happened? What happens if you use this URL:</p>
<pre class="literal-block">
http://localhost:10000/section/page?
</pre>
</div>
</div>
<div class="slide" id="id30">
<h1>HTTP - Resources</h1>
<p>We expect different urls to result in different responses.</p>
<p class="incremental">But this isn't happening with our server, for obvious reasons.</p>
<p class="incremental">It brings us back to the second element of that first line of an HTTP request.</p>
<p class="incremental center"><strong>The Return of the URI</strong></p>
</div>
<div class="slide" id="http-requests-uri">
<h1>HTTP Requests: URI</h1>
<p><tt class="docutils literal">GET</tt> <strong>/path/to/index.html</strong> <tt class="docutils literal">HTTP/1.1</tt></p>
<ul class="incremental">
<li><p class="first">Every HTTP request must include a <strong>URI</strong> used to determine the <strong>resource</strong> to
be returned</p>
</li>
<li><p class="first">URI??
<a class="reference external" href="http://stackoverflow.com/questions/176264/whats-the-difference-between-a-uri-and-a-url/1984225#1984225">http://stackoverflow.com/questions/176264/whats-the-difference-between-a-uri-and-a-url/1984225#1984225</a></p>
</li>
<li><p class="first">Resource?  Files (html, img, .js, .css), but also:</p>
<blockquote>
<ul class="incremental simple">
<li>Dynamic scripts</li>
<li>Raw data</li>
<li>API endpoints</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="slide" id="responding-to-uris">
<h1>Responding to URIs</h1>
<p>We should expand our server's capabilities so that it can make different
responses to different URIs.</p>
<p class="incremental">To simplify things for ourselves, let's allow our server to serve up
directories and files from our own filesystem.</p>
<p class="incremental">This will be much like other common HTTP servers, like Apache or nginx.</p>
<p class="incremental">Save your <tt class="docutils literal">http_server_1.py</tt> module as <tt class="docutils literal">http_server_2.py</tt>. If you've
fallen behind, you can find a copy of <tt class="docutils literal">http_server_2.py</tt> in the class
resources folder.</p>
</div>
<div class="slide" id="getting-a-uri">
<h1>Getting a URI</h1>
<p>First, let's update our <tt class="docutils literal">parse_request</tt> method so that it returns the URI it
parses from the first line of our request:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">first_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;We only accept GET&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'serving request for </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">uri</span>
    <span class="k">return</span> <span class="n">uri</span>
</pre>
<p class="incremental">Next, we need to write a function that handles this uri for us:
<tt class="docutils literal">resolve_uri</tt>.</p>
</div>
<div class="slide" id="what-should-it-do">
<h1>What Should It Do?</h1>
<p>Let's think for a bit about the specs for our function:</p>
<ul class="incremental simple">
<li>It should take a URI as the sole argument</li>
<li>It should use the pathname represented by the URI as a search path for a
filesystem location</li>
<li>It should have a 'home directory', someplace that serves as the root of the
search path.</li>
<li>If the URI represents a directory, the method should return a directory
listing</li>
<li>If the URI represents a file of some sort, the method should return the
contents of that file.</li>
<li>If the URI does not map to a real location, it should raise an exception.</li>
</ul>
</div>
<div class="slide" id="id31">
<h1>My Solution</h1>
<pre class="code python small incremental literal-block">
<span class="c"># at the top of the file:</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c"># add this function</span>
<span class="k">def</span> <span class="nf">resolve_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the filesystem resources identified by 'uri'&quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="s">'webroot'</span> <span class="c"># this is relative to the location of</span>
                     <span class="c"># the server script, could be a full path</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">'/'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">contents</span><span class="p">:</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">listing</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">listing</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Not Found&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="returning-content">
<h1>Returning Content</h1>
<p>Now we have to do something with the return value of that function.</p>
<p class="incremental">The value should be returned to the client as a response.</p>
<p class="incremental">Let's update our <tt class="docutils literal">response_ok</tt> function to incorporate this stuff.</p>
<p class="incremental">Remember, this new material is the <em>body</em> of our response.</p>
</div>
<div class="slide" id="id32">
<h1>My Solution</h1>
<pre class="code python incremental literal-block">
<span class="k">def</span> <span class="nf">response_ok</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns a basic HTTP response&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Content-Type: text/plain&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="handling-the-error">
<h1>Handling The Error</h1>
<p>Our <tt class="docutils literal">resolve_uri</tt> function also adds a new possible error condition, one
that maps nicely to a common HTTP response code.</p>
<p class="incremental">We'll need a function that generates that response for us</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">response_not_found</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;return a 404 Not Found response&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 404 Not Found&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id33">
<h1>Server Updates</h1>
<p>Finally, we need to update the code in our server loop to handle this new
stuff.</p>
<ul class="incremental simple">
<li>It should bind the return value of <tt class="docutils literal">parse_request</tt> to a symbol</li>
<li>It should pass that value in to our new <tt class="docutils literal">resolve_uri</tt> function</li>
<li>It should bind the return value of that function to another symbol</li>
<li>It should use that value to build an <tt class="docutils literal">OK</tt> response</li>
<li>It should return that response to the client via the open connection socket.</li>
<li>If the ValueError from <tt class="docutils literal">resolve_uri</tt> is raised, it should handle it by
returning the proper response.</li>
</ul>
</div>
<div class="slide" id="id34">
<h1>My Solution</h1>
<pre class="code python small incremental literal-block">
<span class="c"># ...</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">break</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">resolve_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_method_not_allowed</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_not_found</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_ok</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'sending response'</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="c"># ...</span>
</pre>
</div>
<div class="slide" id="id35">
<h1>Test Your Work</h1>
<p>To test our new functionality, we need a bit of extra stuff, like a directory
with interesting material in it.</p>
<p class="incremental">In the class resources folder, I've provided a suitable directory. It's called
<tt class="docutils literal">webroot</tt>.</p>
<p class="incremental">Copy that directory and all its contents into the location where you've been
creating your server files.</p>
<p class="incremental">Restart your server: <tt class="docutils literal">$ python http_server_2.py</tt></p>
</div>
<div class="slide" id="what-s-missing">
<h1>What's Missing?</h1>
<p>Point your browser at <tt class="docutils literal"><span class="pre">http://localhost:10000/</span></tt>.</p>
<p class="incremental">Try <tt class="docutils literal"><span class="pre">http://localhost:10000/a_web_page.html</span></tt>.</p>
<p class="incremental">How about <tt class="docutils literal"><span class="pre">http://localhost:10000/images/JPEG_example.jpg</span></tt>?</p>
<p class="incremental">What's going wrong here?</p>
</div>
<div class="slide" id="http-headers">
<h1>HTTP Headers</h1>
<p>The problem is that we're identifying <strong>all</strong> the content we return as plain
text.</p>
<p class="incremental">We can fix this by passing information about exactly what we are returning as
part of the response.</p>
<p class="incremental">HTTP provides for this type of thing with the generic idea of <em>Headers</em></p>
</div>
<div class="slide" id="id36">
<h1>HTTP Headers</h1>
<p>Both requests and responses can contain <strong>headers</strong> of the form <tt class="docutils literal">Name: Value</tt></p>
<ul class="incremental simple">
<li>HTTP 1.0 has 16 valid headers, 1.1 has 46</li>
<li>Any number of spaces or tabs may separate the <em>name</em> from the <em>value</em></li>
<li>If a header line starts with spaces or tabs, it is considered part of the
value for the previous header</li>
<li>Header <em>names</em> are <strong>not</strong> case-sensitive, but <em>values</em> may be</li>
</ul>
<p class="incremental">read more about HTTP headers: <a class="reference external" href="http://www.cs.tut.fi/~jkorpela/http.html">http://www.cs.tut.fi/~jkorpela/http.html</a></p>
</div>
<div class="slide" id="content-type-header">
<h1>Content-Type Header</h1>
<p>A very common header used in HTTP responses is <tt class="docutils literal"><span class="pre">Content-Type</span></tt>. It tells the
client what to expect.</p>
<ul class="incremental simple">
<li>uses <strong>mime-type</strong> (Multi-purpose Internet Mail Extensions)</li>
<li>foo.jpeg - <tt class="docutils literal"><span class="pre">Content-Type:</span> image/jpeg</tt></li>
<li>foo.png - <tt class="docutils literal"><span class="pre">Content-Type:</span> image/png</tt></li>
<li>bar.txt - <tt class="docutils literal"><span class="pre">Content-Type:</span> text/plain</tt></li>
<li>baz.html - <tt class="docutils literal"><span class="pre">Content-Type:</span> text/html</tt></li>
</ul>
<p class="incremental">There are <em>many</em> mime-type identifiers:
<a class="reference external" href="http://www.webmaster-toolkit.com/mime-types.shtml">http://www.webmaster-toolkit.com/mime-types.shtml</a></p>
</div>
<div class="slide" id="mapping-mime-types">
<h1>Mapping Mime-types</h1>
<p>By mapping a given file to a mime-type, we can write a header.</p>
<p class="incremental">The standard lib module <tt class="docutils literal">mimetypes</tt> does just this.</p>
<div class="incremental container">
<p>We can guess the mime-type of a file based on the filename or map a file
extension to a type:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="s">'file.txt'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'text/plain'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="p">[</span><span class="s">'.txt'</span><span class="p">]</span>
<span class="s">'text/plain'</span>
</pre>
</div>
</div>
<div class="slide" id="build-a-content-type-header">
<h1>Build a Content-type Header</h1>
<p>We'll need to do a couple of things:</p>
<ul class="incremental simple">
<li>Extend the <tt class="docutils literal">resolve_uri</tt> function to return content <em>and</em> mime-type</li>
<li>Extend the <tt class="docutils literal">response_ok</tt> function to accept both content and mime-type as
arguments</li>
<li>Extend the <tt class="docutils literal">response_ok</tt> function to write a <tt class="docutils literal"><span class="pre">Content-Type:</span> XYZ</tt> header</li>
<li>Adjust the server loop appropriately</li>
</ul>
</div>
<div class="slide" id="id37">
<h1>My Solution</h1>
<p>for <tt class="docutils literal">resolve_uri</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="c"># at the top of the file:</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>

<span class="c"># in the existing function:</span>
<span class="c"># ...</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">'text/plain'</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">contents</span><span class="p">,</span> <span class="n">mimetype</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">listing</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">listing</span><span class="p">,</span> <span class="s">'text/plain'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Not Found&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id38">
<h1>My Solution</h1>
<p>for <tt class="docutils literal">response_ok</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">response_ok</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">mimetype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns a basic HTTP response&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Content-Type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mimetype</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id39">
<h1>My Solution</h1>
<p>for the server loop:</p>
<pre class="code python small incremental literal-block">
<span class="c"># ...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">content</span><span class="p">,</span> <span class="n">mimetype</span> <span class="o">=</span> <span class="n">resolve_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_method_not_allowed</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_not_found</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">response_ok</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">mimetype</span><span class="p">)</span>

<span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">'sending response'</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="c"># ...</span>
</pre>
</div>
<div class="slide" id="id40">
<h1>Test Your Work</h1>
<p>Now, restart your server script and point your browser at various URLs, starting
from the root (<tt class="docutils literal"><span class="pre">http://localhost:10000/</span></tt>).</p>
<p class="incremental">Much better results, no?</p>
</div>
<div class="slide" id="a-few-steps-further">
<h1>A Few Steps Further</h1>
<ul class="incremental simple">
<li>Format directory listings as actual HTML, so you can make file names into
links.</li>
<li>Add a GMT <tt class="docutils literal">Date:</tt> header in the proper format (RFC-1123) to responses.
<em>hint: see email.utils.formatdate in the python standard library</em></li>
<li>Add a <tt class="docutils literal"><span class="pre">Content-Length:</span></tt> header for <tt class="docutils literal">OK</tt> responses that provides a
correct value.</li>
<li>Protect your server against errors by providing, and using, a function that
returns a <tt class="docutils literal">500 Internal Server Error</tt> response.</li>
<li>Instead of returning the python script in <tt class="docutils literal">webroot</tt> as plain text, execute
the file and return the results as HTML.</li>
</ul>
</div>
<div class="slide" id="wrap-up">
<h1>Wrap-Up</h1>
<p>For comparison, you might wish to take a look at the code in the Python
Standard Library's <tt class="docutils literal">SocketServer</tt>, <tt class="docutils literal">BaseHTTPServer</tt> and
<tt class="docutils literal">SimpleHTTPServer</tt> modules:</p>
<pre class="literal-block">
&gt;&gt;&gt; import SocketServer, BaseHTTPServer, SimpleHTTPServer
&gt;&gt;&gt; SocketServer.__file__
'/full/path/to/your/copy/of/SocketServer.py'
...
</pre>
<p class="incremental center"><strong>See You Tomorrow!</strong></p>
</div>
</div>
</body>
</html>

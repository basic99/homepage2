<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<p>blah blah blah</p>

</div>
<div class="slide" id="detail-view">
<h1>Detail View</h1>
<p>Back in our <tt class="docutils literal">polls</tt> app, let's edit <tt class="docutils literal">urls.py</tt> again:</p>
<pre class="code python incremental small literal-block">
<span class="c"># add this import</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span>

<span class="c"># and edit the detail url like so:</span>
<span class="n">url</span><span class="p">(</span><span class="s">r'^(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span>
    <span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">Poll</span><span class="p">,</span>
        <span class="n">template_name</span><span class="o">=</span><span class="s">&quot;polls/detail.html&quot;</span>
    <span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;poll_detail&quot;</span><span class="p">),</span>
</pre>
<p class="incremental">Again, we only need to add a template.</p>
</div>
<div class="slide" id="forms-in-django">
<h1>Forms in Django</h1>
<p>We want to be able to vote on a poll.</p>
<p class="incremental">Because doing so involves changing data on the server, we should do this with
a POST request.</p>
<p class="incremental">An html form is a simple way to allow us to force a POST request.</p>
<p class="incremental">Data-altering requests are vulnerable to Cross-Site Request Forgery, a common
attack vector.</p>
</div>
<div class="slide" id="danger-csrf">
<h1>Danger: CSRF</h1>
<p>Django not only provides a convenient system to fight this, it <em>requires</em> it
for any POST requests.</p>
<p class="incremental">The Django middleware that does this is enabled by default. All you need to do
is include the {% csrf_token %} tag in your form template.</p>
<p class="incremental">Create a new file <tt class="docutils literal">detail.html</tt> in your <tt class="docutils literal">templates/polls</tt> directory</p>
</div>
<div class="slide" id="detail-template">
<h1>Detail Template</h1>
<pre class="code django small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">poll</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;
</span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">poll.choice_set.count</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="cp">%}</span><span class="x">
&lt;form action=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="nv">poll_vote</span> <span class="nv">poll.pk</span> <span class="cp">%}</span><span class="x">&quot; method=&quot;POST&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x">
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">poll.choice_set.all</span> <span class="cp">%}</span><span class="x">
  &lt;div class=&quot;choice&quot;&gt;
    &lt;label for=&quot;choice_</span><span class="cp">{{</span> <span class="nv">choice.pk</span> <span class="cp">}}</span><span class="x">&quot;&gt;
      &lt;input type=&quot;radio&quot; name=&quot;choice&quot; id=&quot;choice_</span><span class="cp">{{</span> <span class="nv">choice.pk</span> <span class="cp">}}</span><span class="x">&quot;
             value=&quot;</span><span class="cp">{{</span> <span class="nv">choice.pk</span> <span class="cp">}}</span><span class="x">&quot;/&gt;
      </span><span class="cp">{{</span> <span class="nv">choice</span> <span class="cp">}}</span><span class="x">&lt;/label&gt;&lt;/div&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
  &lt;input type=&quot;submit&quot; name=&quot;vote&quot; value=&quot;Vote&quot;/&gt;
&lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
&lt;p&gt;No choices are available for this poll&lt;/p&gt;
</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="processing-the-vote">
<h1>Processing The Vote</h1>
<p>We can now submit a form to the <tt class="docutils literal">poll_vote</tt> url. We need to process that
vote</p>
<p class="incremental">Here, a class-based generic view is just going to get in our way.  Let's use
an old-fashioned view function.</p>
<p class="incremental">How is our user's vote reaching the server?</p>
<p class="incremental">It gets there as POST data, the value for the key 'choice'.</p>
</div>
<div class="slide" id="django-get-and-post-data">
<h1>Django GET and POST Data</h1>
<p>Django provides the same type of Request/Response based interaction model that
most frameworks are based on. Views are called with the first argument being a
<tt class="docutils literal">request</tt> object.</p>
<p class="incremental">request.GET and request.POST are dictionary-like objects containing data
parsed from incoming HTTP request.</p>
<p class="incremental">You can use normal dictionary syntax to read values from these:</p>
<pre class="code python incremental small literal-block">
<span class="n">bar</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'bucko'</span><span class="p">]</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'somevar'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="vote-view-skeleton">
<h1>Vote View Skeleton</h1>
<p>In <tt class="docutils literal">views.py</tt> from our <tt class="docutils literal">polls</tt> app package:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="k">def</span> <span class="nf">vote_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># attempt to get a choice</span>
        <span class="k">except</span> <span class="n">NoGoodChoice</span><span class="p">:</span> <span class="c"># send back to detail</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'poll_detail'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">,</span> <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># vote and send to result</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'poll_result'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># submitted via GET, ignore it</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'poll_detail'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">,</span> <span class="p">])</span>

    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="get-the-choice">
<h1>Get the Choice</h1>
<p>Let's start by filling out the process of getting the choice:</p>
<pre class="code python small literal-block">
<span class="c"># add imports</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Poll</span><span class="p">,</span> <span class="n">Choice</span>
<span class="c"># and edit our skeleton</span>
<span class="k">def</span> <span class="nf">vote_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">poll</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Poll</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">poll</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'choice'</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Ooops, pick a choice that exists, please&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'poll_detail'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">,</span> <span class="p">])</span>
</pre>
</div>
<div class="slide" id="add-a-vote">
<h1>Add a Vote</h1>
<p>Next, let's record a vote on our choice:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">vote_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># choice = ...</span>
    <span class="k">except</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c"># ...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                             <span class="s">&quot;You voted for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">choice</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'poll_result'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="add-the-url">
<h1>Add the URL</h1>
<p>Finally, we need to add this view to our urlconf. Back in <tt class="docutils literal">urls.py</tt> in the
<tt class="docutils literal">polls</tt> app package, edit the url for the voting view like so:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^(?P&lt;pk&gt;\d+)/vote/$'</span><span class="p">,</span>
    <span class="s">'polls.views.vote_view'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;poll_vote&quot;</span><span class="p">),</span>
</pre>
<p class="incremental">Notice that the 'callable' in this pattern is a string. Django allows you to
use this sort of <em>dotted name</em> reference. It will resolve it (or throw an
error if it can't)</p>
</div>
<div class="slide" id="display-result">
<h1>Display Result</h1>
<p>The last view we need is the poll result. This can simply be a different
version of the Generic DetailView. Still in <tt class="docutils literal">urls.py</tt> edit the pattern for
the results view:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^(?P&lt;pk&gt;\d+)/result/$'</span><span class="p">,</span>
    <span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">Poll</span><span class="p">,</span>
        <span class="n">template_name</span><span class="o">=</span><span class="s">&quot;polls/result.html&quot;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;poll_result&quot;</span><span class="p">)</span>
</pre>
<p class="incremental">And, of course, we will need to create that final template</p>
</div>
<div class="slide" id="result-template">
<h1>Result Template</h1>
<p>In <tt class="docutils literal">templates/polls</tt> create a new file, <tt class="docutils literal">result.html</tt>:</p>
<pre class="code django small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">

</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">poll</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;
&lt;ul&gt;
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">poll.choice_set.all</span> <span class="cp">%}</span><span class="x">
  &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">choice</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span><span class="nv">choice.votes</span><span class="cp">}}</span><span class="x"> votes)&lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
&lt;/ul&gt;
&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="nv">poll_list</span> <span class="cp">%}</span><span class="x">&quot;&gt;Back to the polls, please&lt;/a&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="play-a-bit">
<h1>Play a Bit</h1>
<p>Alright. You've done it.</p>
<p>Take a few minutes to add some polls in the Admin.</p>
<p>Then return to the public side and vote. See how it goes.</p>
</div>
</div>
</body>
</html>

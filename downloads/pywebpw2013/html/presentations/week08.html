<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/pyramid-medium.png" class="align-left" src="img/pyramid-medium.png" style="width: 50%;" />
<p>Week 8: Pyramid</p>
<div class="intro-blurb right line-block">
<div class="line">Wherein we learn</div>
<div class="line">it's not built by aliens</div>
</div>

</div>
<div class="slide" id="but-first">
<h1>But First</h1>
<p class="big-centered">Questions from the Reading?</p>
</div>
<div class="slide" id="and-now">
<h1>And Now</h1>
<img alt="img/sheep_pyramid.jpg" class="align-center" src="img/sheep_pyramid.jpg" style="width: 65%;" />
<p class="image-credit">image: Ionics <a class="reference external" href="http://www.flickr.com/photos/ionics/6337525967/">http://www.flickr.com/photos/ionics/6337525967/</a> - CC_BY</p>
</div>
<div class="slide" id="what-is-pyramid">
<h1>What is Pyramid?</h1>
<p>A Web Framework</p>
<p class="incremental">&quot;Its primary job is to make it easier for a developer to create an arbitrary
web application&quot;</p>
<p class="incremental">Makes as few decisions as possible for you.</p>
<p class="incremental">Allows <em>you</em> to make decisions, and provides tools to support you when you do</p>
<p class="incremental">&quot;Pay only for what you eat&quot;</p>
</div>
<div class="slide" id="why-is-pyramid">
<h1>Why is Pyramid?</h1>
<p>Micro-frameworks are great for lightweight apps</p>
<p class="incremental">Micro-frameworks do not scale up or change specs easily</p>
<p class="incremental">Full-stack frameworks have lots of opinions. <em>Bending</em> them can be difficult.</p>
<p class="incremental">Pyramid can build a lightweight app easily, but it can also scale and bend</p>
</div>
<div class="slide" id="history-zope-and-repoze">
<h1>History - Zope and Repoze</h1>
<p>Many of the core developers of Pyramid started as Zope developers.</p>
<p class="incremental">Born in 1996, Zope was the first Python web framework, and possibly the first
in any language.</p>
<p class="incremental">After 14 years, the developers of Zope had seen and learned <em>a lot</em>.</p>
<p class="incremental">Repoze was a short-lived (2008-2010) framework intended to embody the lessons
learned from Zope.</p>
</div>
<div class="slide" id="history-pylons">
<h1>History - Pylons</h1>
<p>Pylons was released in 2005.</p>
<p class="incremental">It was among the first frameworks to fully embrace the WSGI specification.</p>
<p class="incremental">The creators of Pylons build WebTest, WebError and WebOb (abstracted HTTP
request and response objects)</p>
</div>
<div class="slide" id="history-2010">
<h1>History - 2010</h1>
<p>In 2010, the authors of Repoze and Pylons got together and made an unusual
decision.</p>
<p class="incremental">Why duplicate efforts when there are already so many other frameworks?</p>
<p class="incremental">Repoze was re-named 'Pyramid' and the 'Pylons Project' was born to shepherd
this new combined project.</p>
</div>
<div class="slide" id="implications">
<h1>Implications</h1>
<p>Pylons was a framework predicated largely on relational persistence and URL
Dispatch.</p>
<p class="incremental">Zope/Repoze was based on the ZODB and Object Traversal.</p>
<p class="incremental">Each of these approaches has strengths and weaknesses.</p>
<p class="incremental">Pyramid supports neither, both and even combinations of the two.</p>
</div>
<div class="slide" id="relational-db-url-dispatch">
<h1>Relational DB / URL Dispatch</h1>
<p>You've seen this before, both in Flask and Django</p>
<p class="incremental">SQLite3, the Django ORM, both are examples of relational persistence models</p>
<p class="incremental">Routes/urlpatterns, both are examples of URL Dispatch</p>
<p class="incremental">Pyramid can work this way too.  SQLAlchemy, Route-based views.</p>
<p class="incremental">Been there, done that.  Let's see something else.</p>
</div>
<div class="slide" id="zodb">
<h1>ZODB</h1>
<p>ORMs allow developers to pretend that Objects are like DB Tables.</p>
<p class="incremental">But Objects are <em>not</em> tables, so there's a <a class="reference external" href="http://en.wikipedia.org/wiki/Object-relational_impedance_mismatch">conceptual mismatch</a> between
the two.</p>
<p class="incremental">The ZODB is an <em>object store</em>, rather than a relational database.</p>
<p class="incremental">If your data is best represented by <em>heterogenous</em> objects, it's a better
persistence solution.</p>
</div>
<div class="slide" id="traversal-object-graphs">
<h1>Traversal - Object Graphs</h1>
<p>Python objects can <em>contain</em> other objects.</p>
<p class="incremental">Using <em>dict</em>-like structures, you can build a <em>graph</em> of objects:</p>
<pre class="incremental literal-block">
Family
├── Parents
│  ├── Cris
│  ├── Kristina
├── Children
│  ├── Kieran
│  ├── Finnian
</pre>
</div>
<div class="slide" id="traversal-path-lookup">
<h1>Traversal - Path Lookup</h1>
<p>You can <em>traverse</em> across the object graph by treating a URL as a series of
<em>node names</em></p>
<pre class="incremental small literal-block">
http://family/parents/cris -&gt; family['parents']['cris']
</pre>
<p class="incremental">Further path segments can be view names or information passed to the view</p>
<pre class="incremental small literal-block">
http://family/parents/cris/edit -&gt; edit view
http://family/parents/cris/next/steps -&gt; subpath = /next/steps
</pre>
</div>
<div class="slide" id="break-time">
<h1>Break Time</h1>
<p>We've got the concept of object stores and traversal</p>
<p class="incremental">The next step is to see how those work in real life.</p>
<p class="incremental">Take the next few minutes here to ensure that you have a working Pyramid setup
with the ZODB and a project created with <tt class="docutils literal">pcreate <span class="pre">-s</span> zodb</tt>.</p>
</div>
<div class="slide" id="lab-part-one">
<h1>Lab - Part One</h1>
<p class="big-centered">Getting To Know Pyramid</p>
</div>
<div class="slide" id="scaffolds-and-opinions">
<h1>Scaffolds and Opinions</h1>
<p>Pyramid uses what it calls <em>scaffolds</em> to get you started on a new project.</p>
<p class="incremental">When you ran <tt class="docutils literal">pcreate <span class="pre">-s</span> zodb wikitutorial</tt> you were invoking the <em>zodb
scaffold</em></p>
<p class="incremental">Pyramid the framework is highly un-opinionated.</p>
<p class="incremental"><em>Scaffolds</em>, conversely, can be quite opinionated.  The one we used has chosen
our persistence mechanism (ZODB) and how we will reach our code (Traversal).</p>
</div>
<div class="slide" id="project-layout">
<h1>Project Layout</h1>
<p>Running <tt class="docutils literal">pcreate</tt> has set up a file structure for us:</p>
<pre class="small literal-block">
wikitutorial/
    CHANGES.txt
    development.ini
    MANIFEST.in
    production.ini
    README.txt
    setup.cfg
    setup.py
    wikitutorial/
        __init__.py
        models.py
        static/
        templates/
        tests.py
        views.py
</pre>
</div>
<div class="slide" id="similarities-to-django">
<h1>Similarities to Django</h1>
<p>Our project is organized with an outer <em>project</em> folder and an inner <em>package</em>
folder (see the <tt class="docutils literal">__init__.py</tt>?)</p>
<p class="incremental">The name of that outer directory is not really important.</p>
<p class="incremental">Our inner <em>package</em> folder has a models.py, tests.py and views.py module</p>
<p class="incremental">Our inner <em>package</em> folder has a <tt class="docutils literal">static/</tt> and <tt class="docutils literal">templates/</tt> directory</p>
</div>
<div class="slide" id="differences-from-django">
<h1>Differences from Django</h1>
<p>Our <em>outer</em> module has a <tt class="docutils literal">setup.py</tt> file, which allows it to be installed
with <tt class="docutils literal">pip</tt> or <tt class="docutils literal">easy_install</tt></p>
<p class="incremental">There is no <tt class="docutils literal">manage.py</tt> file.  Pyramid commands are console scripts.</p>
<p class="incremental">There is nothing magical in Pyramid about the name of the <tt class="docutils literal">models.py</tt>
module.</p>
<p class="incremental">There is nothing magical in Pyramid about the names of the <tt class="docutils literal">static/</tt> or
<tt class="docutils literal">templates/</tt> directories.</p>
</div>
<div class="slide" id="pyramid-system-configuration">
<h1>Pyramid System Configuration</h1>
<p>Pyramid keeps configuration intended for an entire installation in <tt class="docutils literal">.ini</tt>
files at the top of a project.</p>
<p class="incremental">When you deploy an app to some wsgi server, you'll reference one of these files</p>
<p class="incremental">Settings there affect the environment of all apps that are running in that
wsgi server.</p>
<p class="incremental">It is much like Django's <tt class="docutils literal">settings.py</tt> but is not a python module.</p>
</div>
<div class="slide" id="pyramid-is-python">
<h1>Pyramid is Python</h1>
<p>Running a Pyramid application is really just like running a Python module. In
the <tt class="docutils literal">__init__.py</tt> file of your app <em>package</em>, you'll find a <tt class="docutils literal">main</tt>
function:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.
    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span><span class="p">,</span>
                          <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s">'static'</span><span class="p">,</span> <span class="s">'static'</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre>
<p class="incremental">App-level configuration is done here.</p>
</div>
<div class="slide" id="app-configuration">
<h1>App Configuration</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
</pre>
<p class="incremental"><tt class="docutils literal">global_config</tt> will be a dictionary of the settings from your <tt class="docutils literal">.ini</tt> file
that come in the [DEFAULT] section (if there is one).  These settings will be
shared across all apps that are involved in the system.</p>
<p class="incremental">The <tt class="docutils literal">settings</tt> passed in here are the settings from your <tt class="docutils literal">.ini</tt> file that
come in the section that corresponds to your application.  They will be used
only by your app.</p>
</div>
<div class="slide" id="id1">
<h1>App Configuration</h1>
<pre class="code python small literal-block">
<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span><span class="p">,</span>
                      <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s">'static'</span><span class="p">,</span> <span class="s">'static'</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre>
<p class="incremental">Pyramid does configuration work when an app is run using the <tt class="docutils literal">Configurator</tt>
class.</p>
<p class="incremental">The <tt class="docutils literal">Configurator</tt> provides an extensible API for configuring just about
everything.</p>
<p class="incremental">You can read more in <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/api/config.html">the pyramid.config documentation</a></p>
</div>
<div class="slide" id="the-application-root">
<h1>The Application Root</h1>
<p>The <tt class="docutils literal">Configurator</tt> constructor can take a <tt class="docutils literal">root_factory</tt> keyword argument.</p>
<p class="incremental">The <tt class="docutils literal">root_factory</tt> of your app returns the router that determines how to
dispatch individual requests.</p>
<p class="incremental">If you do not provide this argument, the default root factory, which uses URL
Dispatch, will be used.</p>
<p class="incremental">In our case, we want to use Traversal for our app, so we provide a custom
<tt class="docutils literal">root_factory</tt>.</p>
</div>
<div class="slide" id="our-root-factory">
<h1>Our Root Factory</h1>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">pyramid_zodbconn</span> <span class="kn">import</span> <span class="n">get_connection</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">appmaker</span>

<span class="k">def</span> <span class="nf">root_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appmaker</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">root</span><span class="p">())</span>
</pre>
<p class="incremental">We grab a connection to the ZODB and pass that into a call to <tt class="docutils literal">appmaker</tt>,
the result is returned (and becomes our app root).</p>
<p class="incremental">So what exactly does <tt class="docutils literal">appmaker</tt> do?</p>
</div>
<div class="slide" id="the-appmaker">
<h1>The appmaker</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">appmaker</span><span class="p">(</span><span class="n">zodb_root</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">'app_root'</span> <span class="ow">in</span> <span class="n">zodb_root</span><span class="p">:</span>
        <span class="n">app_root</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
        <span class="n">zodb_root</span><span class="p">[</span><span class="s">'app_root'</span><span class="p">]</span> <span class="o">=</span> <span class="n">app_root</span>
        <span class="kn">import</span> <span class="nn">transaction</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zodb_root</span><span class="p">[</span><span class="s">'app_root'</span><span class="p">]</span>
</pre>
<p class="incremental">We ensure that there is an <tt class="docutils literal">app_root</tt> object stored in the ZODB, and return
it. That simple Python object will manage our <em>Traversal</em> based application.</p>
</div>
<div class="slide" id="seeing-it-live">
<h1>Seeing It Live</h1>
<p>You've done this at home, but let's repeat the exercise here.</p>
<p class="incremental">In a terminal, change directories into your <tt class="docutils literal">wikitutorial</tt> <em>project</em> folder
(where you see <tt class="docutils literal">development.ini</tt>). Fire up your pyramid virtualenv and serve
our app:</p>
<pre class="incremental literal-block">
(pyramidenv)$ pserve development.ini
Starting server in PID 16698.
serving on http://0.0.0.0:6543
</pre>
<p class="incremental">Load <a class="reference external" href="http://localhost:6543">http://localhost:6543</a> and view your app root.</p>
</div>
<div class="slide" id="why-is-it-pretty">
<h1>Why is it Pretty?</h1>
<p>If we understand correctly what is happening so far, we are looking at an
instance of <tt class="docutils literal">MyModel</tt>.</p>
<p class="incremental">What makes it look like this?</p>
<p class="incremental">The secret sauce lies in <em>view configuration</em></p>
</div>
<div class="slide" id="pyramid-views">
<h1>Pyramid Views</h1>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">MyModel</span>

<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">MyModel</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/mytemplate.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'project'</span><span class="p">:</span> <span class="s">'wikitutorial'</span><span class="p">}</span>
</pre>
<p class="incremental">Pyramid views can be configured with the <tt class="docutils literal">&#64;view_config()</tt> decorator.</p>
<p class="incremental">Or call <tt class="docutils literal">config.add_view()</tt> method in your app <tt class="docutils literal">main</tt>.</p>
<p class="incremental"><tt class="docutils literal">config.scan()</tt> in <tt class="docutils literal">main</tt> picks up all config decorators.</p>
</div>
<div class="slide" id="view-configuration">
<h1>View Configuration</h1>
<p class="small">The <tt class="docutils literal">view_config</tt> decorator (and the <tt class="docutils literal">add_view</tt> method) take a number of
interesting arguments.  In our case there are two.</p>
<p class="incremental small"><tt class="docutils literal">renderer</tt> is used to designate how the results returned by the view
callable will be handled. In our case, it's a template that will render to an
HTML page.</p>
<p class="incremental small"><tt class="docutils literal">context</tt> determines the <em>type</em> of object for which this view may be used. It
is an example of a <tt class="docutils literal">predicate</tt> argument, which can be used to place
restrictions on when and how a view may be called.</p>
<p class="incremental small">Predicates are a very powerful system for choosing views. Read more about them
in <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/1.1-branch/narr/viewconfig.html">view configuration</a></p>
</div>
<div class="slide" id="lab-part-two">
<h1>Lab - Part Two</h1>
<p class="big-centered">Data Models and Tests</p>
</div>
<div class="slide" id="wiki-models">
<h1>Wiki Models</h1>
<p>Now that we have a basic idea of what's going on in the code generated for us,
it's time to build our wiki models.</p>
<p class="incremental">We'll need to have a Python class that corresponds to a <em>page</em> in our wiki.</p>
<p class="incremental">This will be the type of object we view when we are looking at the wiki.</p>
<p class="incremental">We'll also need to have a <em>root</em> object, which will be a container for all the
<em>pages</em> we create for the wiki.</p>
</div>
<div class="slide" id="persistence-magic">
<h1>Persistence Magic</h1>
<p>In an SQL database, data <em>about</em> an object is written to tables. In the ZODB,
the <em>object itself</em> is saved in the database.</p>
<p class="incremental">The ZODB provides base classes that will <em>automatically save themselves</em>. We
will use two of these:</p>
<ul class="incremental simple">
<li><strong>Persistent</strong> - a class that automatically tracks changes to class
attributes and saves them.</li>
<li><strong>PersistentMapping</strong> - roughly equivalent to a Python <em>dictionary</em>, this
class will save changes to itself <em>and its keys and values</em>.</li>
</ul>
<p class="incremental small">The ZODB also provides lists and more complex persistent data structures like
BTrees.</p>
</div>
<div class="slide" id="traversal-magic">
<h1>Traversal Magic</h1>
<p>Traversal is supported by two object properties: <tt class="docutils literal">__name__</tt> and
<tt class="docutils literal">__parent__</tt>.</p>
<p class="incremental">Every object in a system which is going to use Traversal <strong>must</strong> provide
these two attributes.</p>
<p class="incremental">The <em>root</em> object in a Traversal system will have both of these attributes set
to <tt class="docutils literal">None</tt>.</p>
</div>
<div class="slide" id="the-wiki-class">
<h1>The Wiki Class</h1>
<p>Open <tt class="docutils literal">models.py</tt> from our <tt class="docutils literal">wikitutorial</tt> <em>package</em> directory.</p>
<p class="incremental">First, delete the <tt class="docutils literal">MyModel</tt> class.  We won't need it.</p>
<p class="incremental">Add the following in its place:</p>
<pre class="code python incremental literal-block">
<span class="k">class</span> <span class="nc">Wiki</span><span class="p">(</span><span class="n">PersistentMapping</span><span class="p">):</span>
    <span class="n">__name__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__parent__</span> <span class="o">=</span> <span class="bp">None</span>
</pre>
</div>
<div class="slide" id="the-page-class">
<h1>The Page Class</h1>
<p>To that same file (models.py) add one import and a second class definition:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">persistent</span> <span class="kn">import</span> <span class="n">Persistent</span>

<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Persistent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</pre>
<p class="incremental">What about <tt class="docutils literal">__name__</tt> and <tt class="docutils literal">__parent__</tt>?</p>
<p class="incremental">We'll add those to each instance when we create it.</p>
</div>
<div class="slide" id="update-appmaker">
<h1>Update Appmaker</h1>
<p>The existing <tt class="docutils literal">appmaker</tt> function needs to be updated for our new models:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">appmaker</span><span class="p">(</span><span class="n">zodb_root</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">'app_root'</span> <span class="ow">in</span> <span class="n">zodb_root</span><span class="p">:</span>
        <span class="n">app_root</span> <span class="o">=</span> <span class="n">Wiki</span><span class="p">()</span>
        <span class="n">frontpage</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="s">'This is the front page'</span><span class="p">)</span>
        <span class="n">app_root</span><span class="p">[</span><span class="s">'FrontPage'</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontpage</span>
        <span class="n">frontpage</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">'FrontPage'</span>
        <span class="n">frontpage</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">app_root</span>
        <span class="n">zodb_root</span><span class="p">[</span><span class="s">'app_root'</span><span class="p">]</span> <span class="o">=</span> <span class="n">app_root</span>
        <span class="kn">import</span> <span class="nn">transaction</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zodb_root</span><span class="p">[</span><span class="s">'app_root'</span><span class="p">]</span>
</pre>
</div>
<div class="slide" id="a-last-bit-of-cleanup">
<h1>A Last Bit of Cleanup</h1>
<p>We've deleted the <tt class="docutils literal">MyModel</tt> class.  But we still have <em>views</em> that
reference the class.</p>
<p class="incremental">Open the <tt class="docutils literal">views.py</tt> file in your <em>package</em> directory and comment out
everything <strong>except</strong> the first line:</p>
<pre class="code python incremental literal-block">
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>
</pre>
<p class="incremental">Next, we'll test our models.</p>
</div>
<div class="slide" id="test-the-wiki-model">
<h1>Test the Wiki Model</h1>
<p>Open <tt class="docutils literal">tests.py</tt> from the <em>package</em> directory. Delete the <tt class="docutils literal">ViewTests</tt>
class and replace it with the following:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">WikiModelTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_getTargetClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">wikitutorial.models</span> <span class="kn">import</span> <span class="n">Wiki</span>
        <span class="k">return</span> <span class="n">Wiki</span>

    <span class="k">def</span> <span class="nf">_makeOne</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTargetClass</span><span class="p">()()</span>

    <span class="k">def</span> <span class="nf">test_it</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wiki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeOne</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wiki</span><span class="o">.</span><span class="n">__parent__</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wiki</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="test-the-page-model">
<h1>Test the Page Model</h1>
<p>Add the following test class as well:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">PageModelTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_getTargetClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">wikitutorial.models</span> <span class="kn">import</span> <span class="n">Page</span>
        <span class="k">return</span> <span class="n">Page</span>

    <span class="k">def</span> <span class="nf">_makeOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">u'some data'</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTargetClass</span><span class="p">()(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeOne</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">u'some data'</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="test-appmaker">
<h1>Test Appmaker</h1>
<p>One more test class:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">AppmakerTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zodb_root</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">appmaker</span>
        <span class="k">return</span> <span class="n">appmaker</span><span class="p">(</span><span class="n">zodb_root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_it</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s">'app_root'</span><span class="p">][</span><span class="s">'FrontPage'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="s">'This is the front page'</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="a-quick-interlude">
<h1>A Quick Interlude</h1>
<p>In your <em>package</em> directory you should see a file: <tt class="docutils literal">Data.fs</tt>.</p>
<p class="incremental">This is the ZODB. It contains references to a class that doesn't exist
anymore (MyModel). This means it is broken.</p>
<p class="incremental">Make sure Pyramid is not running.</p>
<p class="incremental">Delete Data.fs. It will be re-created as needed.</p>
<p class="incremental">You can also delete Data.fs.* (.tmp, .index, .lock)</p>
</div>
<div class="slide" id="run-our-tests">
<h1>Run our Tests</h1>
<p>Finally, let's run our tests:</p>
<pre class="literal-block">
(pyramidenv)$ python setup.py test
...
Ran 3 tests in 0.000s

OK
</pre>
<p class="incremental">We can also run tests to tell us our code-coverage:</p>
<pre class="incremental small literal-block">
(pyramidenv)$ nosetests --cover-package=tutorial --cover-erase --with-coverage
</pre>
</div>
<div class="slide" id="break">
<h1>Break</h1>
<p class="big-centered">Take a few minutes to breathe</p>
</div>
<div class="slide" id="lab-part-three">
<h1>Lab - Part Three</h1>
<p class="big-centered">Views and Templates</p>
</div>
<div class="slide" id="preparing-for-views">
<h1>Preparing for Views</h1>
<p>Our <tt class="docutils literal">Page</tt> model has a <tt class="docutils literal">data</tt> attribute, which represents the text in the
page.</p>
<p class="incremental">Our pages will use ReStructuredText, a plain-text format that can be rendered
to HTML with a Python module called <tt class="docutils literal">docutils</tt>.</p>
<p class="incremental">Our project is installable as a python package. It declares its own
<em>dependencies</em> so that they will also be installed.</p>
<p class="incremental">We need to add the <tt class="docutils literal">docutils</tt> package to this list.</p>
</div>
<div class="slide" id="package-dependencies">
<h1>Package Dependencies</h1>
<p>Open the <tt class="docutils literal">setup.py</tt> file from our <em>project</em> directory. Add <tt class="docutils literal">docutils</tt> to
the list <tt class="docutils literal">requires</tt>:</p>
<pre class="code python literal-block">
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'pyramid'</span><span class="p">,</span>
    <span class="s">'pyramid_zodbconn'</span><span class="p">,</span>
    <span class="s">'transaction'</span><span class="p">,</span>
    <span class="s">'pyramid_tm'</span><span class="p">,</span>
    <span class="s">'pyramid_debugtoolbar'</span><span class="p">,</span>
    <span class="s">'ZODB3'</span><span class="p">,</span>
    <span class="s">'waitress'</span><span class="p">,</span>
    <span class="s">'docutils'</span><span class="p">,</span> <span class="c"># &lt;- ADD THIS</span>
    <span class="p">]</span>
</pre>
</div>
<div class="slide" id="complete-the-change">
<h1>Complete the Change</h1>
<p>Any time you make a change to <tt class="docutils literal">setup.py</tt> for a package you are working on,
you need to re-install that package to pick up the changes:</p>
<pre class="literal-block">
(pyramidenv)$ python setup.py develop
</pre>
<p class="incremental">You'll see a whole bunch of stuff flicker by. In it will be a reference to
<tt class="docutils literal">Searching for docutils</tt>.</p>
</div>
<div class="slide" id="adding-views">
<h1>Adding Views</h1>
<p>Open <tt class="docutils literal">views.py</tt> again.  Add the following:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">docutils.core</span> <span class="kn">import</span> <span class="n">publish_parts</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span> <span class="c"># &lt;- ALREADY THERE</span>

<span class="kn">from</span> <span class="nn">wikitutorial.models</span> <span class="kn">import</span> <span class="n">Page</span>

<span class="c"># regular expression used to find WikiWords</span>
<span class="n">wikiwords</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span><span class="p">)</span>

<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">'.models.Wiki'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                                                   <span class="s">'FrontPage'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="some-notes">
<h1>Some Notes</h1>
<p>New pages in a typical wiki are added by writing <em>WikiWords</em> into the page.</p>
<p class="incremental"><tt class="docutils literal"><span class="pre">r&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span></tt> is a regular expression that will locate
WikiWords.</p>
<p class="incremental">Note that the <tt class="docutils literal">&#64;view_config</tt> for the <tt class="docutils literal">view_wiki</tt> function has no
<tt class="docutils literal">renderer</tt> argument. It will never be <em>shown</em></p>
<p class="incremental">Instead, it returns <tt class="docutils literal">HTTPFound</tt>, (<tt class="docutils literal">302 Found</tt>). Calling
<tt class="docutils literal">request.resource_url</tt> provides a URL for the redirect.</p>
</div>
<div class="slide" id="add-a-page-view">
<h1>Add a Page View</h1>
<pre class="code python small literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">'.models.Page'</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/view.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">wiki</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">__parent__</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wiki</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">'&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">application_url</span> <span class="o">+</span> <span class="s">'/add_page/'</span> <span class="o">+</span> <span class="n">word</span>
            <span class="k">return</span> <span class="s">'&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span>
        <span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s">'html'</span><span class="p">)[</span><span class="s">'html_body'</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'edit_page'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="adding-templates">
<h1>Adding Templates</h1>
<p>What will the page template for the <tt class="docutils literal">view_page</tt> function need to be called?</p>
<p class="incremental">Go ahead and create <tt class="docutils literal">view.pt</tt> in your <tt class="docutils literal">templates</tt> directory.</p>
<p class="incremental">While you're there, also copy the file <tt class="docutils literal">base.pt</tt> from
<tt class="docutils literal">assignments/week08/lab</tt> in the class repo.</p>
<p class="incremental">Like Django templates, Chameleon templates can extend other templates. Our
<tt class="docutils literal">base.pt</tt> template will be the master, and our <tt class="docutils literal">view.pt</tt> and <tt class="docutils literal">edit.pt</tt>
templates will extend it.</p>
</div>
<div class="slide" id="the-view-pt-template">
<h1>The view.pt Template</h1>
<p>Type this code into your <tt class="docutils literal">view.pt</tt> file:</p>
<pre class="code xml literal-block">
<span class="nt">&lt;metal:main</span> <span class="na">use-macro=</span><span class="s">&quot;load: base.pt&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;metal:content</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;main-content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">tal:replace=</span><span class="s">&quot;structure content&quot;</span><span class="nt">&gt;</span>
    Page text goes here.
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">tal:attributes=</span><span class="s">&quot;href edit_url&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
      Edit this page
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
 <span class="nt">&lt;/metal:content&gt;</span>
<span class="nt">&lt;/metal:main&gt;</span>
</pre>
</div>
<div class="slide" id="a-few-notes">
<h1>A Few Notes</h1>
<p>Chameleon page templates are valid XML. The templating language uses <tt class="docutils literal">tal</tt>/<tt class="docutils literal">metal</tt>
namespace XML tag attributes.</p>
<p class="incremental"><tt class="docutils literal">&lt;metal:main <span class="pre">use-macro=&quot;load:</span> base.pt&quot;&gt;</tt> tells us we will be using
<tt class="docutils literal">base.pt</tt> as our main template <em>macro</em>.</p>
<p class="incremental">Template <em>macros</em> can define one or more <em>slots</em>. These are like the <em>blocks</em>
in Jinja2 or Django templates.</p>
<p class="incremental"><tt class="docutils literal">&lt;metal:content <span class="pre">metal:fill-slot=&quot;main-content&quot;&gt;</span></tt> tells us that everything
here will go in the <tt class="docutils literal"><span class="pre">main-content</span></tt> slot.</p>
</div>
<div class="slide" id="more-notes">
<h1>More Notes</h1>
<pre class="code xml literal-block">
<span class="nt">&lt;div</span> <span class="na">tal:replace=</span><span class="s">&quot;structure content&quot;</span><span class="nt">&gt;</span>
  Page text goes here.
<span class="nt">&lt;/div&gt;</span>
</pre>
<p>This uses the <tt class="docutils literal">tal</tt> directive <tt class="docutils literal">replace</tt> to completely replace the
<tt class="docutils literal">&lt;div&gt;</tt> tag with whatever html is in <tt class="docutils literal">content</tt>.</p>
<pre class="code xml incremental literal-block">
<span class="nt">&lt;a</span> <span class="na">tal:attributes=</span><span class="s">&quot;href edit_url&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Edit this page
<span class="nt">&lt;/a&gt;</span>
</pre>
<p class="incremental">Here, we use the <tt class="docutils literal">tal</tt> directive <tt class="docutils literal">attributes</tt> to set the <tt class="docutils literal">href</tt> for our
anchor to the value passed into our template as <tt class="docutils literal">edit_url</tt>.</p>
</div>
<div class="slide" id="view-your-work">
<h1>View Your Work</h1>
<p>We've created the following:</p>
<ul class="incremental small simple">
<li>A wiki view that redirects to the automatically-created FrontPage page</li>
<li>A page view that will render the <tt class="docutils literal">data</tt> from a page, along with a url for
editing that page</li>
<li>A page template to show a wiki page.</li>
</ul>
<p class="incremental">That's all we need to be able to see our work.  Start Pyramid:</p>
<pre class="incremental small literal-block">
(pyramidenv)$ pserve development.ini
Starting server in PID 43925.
serving on http://0.0.0.0:6543
</pre>
<p class="incremental">Load <a class="reference external" href="http://localhost:6543/">http://localhost:6543/</a></p>
</div>
<div class="slide" id="what-you-should-see">
<h1>What You Should See</h1>
<img alt="img/wiki_frontpage.png" class="align-center" src="img/wiki_frontpage.png" style="width: 95%;" />
</div>
<div class="slide" id="editing-a-page">
<h1>Editing a Page</h1>
<p>Back in <tt class="docutils literal">views.py</tt> add the following:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'edit_page'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">'.models.Page'</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/edit.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'form.submitted'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'body'</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'edit_page'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="the-edit-template">
<h1>The Edit Template</h1>
<p>Create and fill <tt class="docutils literal">edit.pt</tt> in <tt class="docutils literal">templates</tt>:</p>
<pre class="code xml small literal-block">
<span class="nt">&lt;metal:main</span> <span class="na">use-macro=</span><span class="s">&quot;load: base.pt&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;metal:pagename</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;page-name&quot;</span><span class="nt">&gt;</span>
  Editing
  <span class="nt">&lt;b&gt;&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;page.__name__&quot;</span><span class="nt">&gt;</span>Page Name Goes Here
     <span class="nt">&lt;/span&gt;&lt;/b&gt;</span>
  <span class="nt">&lt;/metal:pagename&gt;</span>
  <span class="nt">&lt;metal:content</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;main-content&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;${save_url}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span> <span class="na">tal:content=</span><span class="s">&quot;page.data&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span>
                <span class="na">cols=</span><span class="s">&quot;60&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/metal:content&gt;</span>
<span class="nt">&lt;/metal:main&gt;</span>
</pre>
</div>
<div class="slide" id="frontpage-content">
<h1>FrontPage Content</h1>
<p>Restart Pyramid, then back in your browser, click the <tt class="docutils literal">Edit this page</tt> link.</p>
<p class="incremental">Erase the existing text and add this instead:</p>
<pre class="incremental small literal-block">
==========
Front Page
==========

This is the front page.  It features

* a heading
* a list
* a wikiword link to AnotherPage
</pre>
</div>
<div class="slide" id="id3">
<h1>View Your Work</h1>
<p>Click the <em>Save</em> button and see what you've gotten.</p>
<p class="incremental">If you get strangely formatted text that warns you about <em>Title overline too
short</em>, you didn't add enough equals signs above or below the page title. Go
back and ensure that there are the same number of equal signs as the total
number of characters in the title.</p>
<p class="incremental">Note that <tt class="docutils literal">AnotherPage</tt> is a link, click it.</p>
</div>
<div class="slide" id="adding-a-page">
<h1>Adding a Page</h1>
<p>Back in <tt class="docutils literal">views.py</tt> add the code for creating a new page:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'add_page'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">'.models.Wiki'</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/edit.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">subpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">'form.submitted'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'body'</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">context</span><span class="p">[</span><span class="n">pagename</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'add_page'</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id4">
<h1>A Few Notes</h1>
<p>Notice that the <tt class="docutils literal">context</tt> for this view is <em>the Wiki model</em></p>
<p class="incremental"><tt class="docutils literal">pagename = request.subpath[0]</tt> gives us the first element of the path
<em>after</em> the current context and view. What is that?</p>
<p class="incremental">Notice that <em>here</em> is where we set the <tt class="docutils literal">__name__</tt> and <tt class="docutils literal">__parent__</tt>
attributes of our new Page.</p>
<p class="incremental">We add a new Page to the wiki as if the wiki were a Python <tt class="docutils literal">dict</tt>:
<tt class="docutils literal">context[pagename] = page</tt></p>
</div>
<div class="slide" id="one-more-note">
<h1>One More Note</h1>
<p>Look at the similarity in how a form is handled here to the way it is handled
in Django (in pseudocode):</p>
<pre class="incremental literal-block">
if the_form_is_submitted:
    handle_the_form()
    return go_to_the_success_url()
return an_empty_form()
</pre>
<p class="incremental">Forms that modify data should only be handled on POST.</p>
<p class="incremental">Could you improve this code to ensure that?</p>
</div>
<div class="slide" id="and-a-question">
<h1>And a Question</h1>
<p class="big-centered">Why do we create a new, empty <tt class="docutils literal">Page</tt> object at the end of the add_page view?</p>
</div>
<div class="slide" id="in-class-exercises">
<h1>In-Class Exercises</h1>
<p>Try to accomplish as many of these as you can before you leave:</p>
<ul class="incremental simple">
<li>Make the add_page view show &quot;Adding &lt;NewPage&gt;&quot; in the header (<em>do not create
a new template to do this</em>)</li>
<li>Make the edit_page and add_page views <strong>only</strong> change data on POST.</li>
<li>Make the link that says &quot;You can return to the FrontPage&quot; disappear when you
are viewing the front page.</li>
</ul>
</div>
<div class="slide" id="assignment">
<h1>Assignment</h1>
<p>By now you should have some idea what you want to do for your final project.</p>
<p class="incremental">Your assignment this week is to get started on it.</p>
<p class="incremental">If you have not already done so, please talk to Dan or me about your ideas. I
want to help you pick something you can get done in time.</p>
<p class="incremental">If you are stuck on how to start, reach out to Dan or me. We are here to help
you.</p>
</div>
<div class="slide" id="next-week">
<h1>Next Week</h1>
<p>Next week we will have a short lecture about deployment options for Python web
applications.</p>
<p class="incremental">We'll look at deploying to shared hosting servers, VPSs and 'the cloud'.</p>
<p class="incremental">Your classmate Austin will give a short talk on the tools he used to deploy
<tt class="docutils literal">djangor</tt> to his VM in last week's class.</p>
<p class="incremental">And the rest of the time (about 1.5-2 hours) will be reserved for working on
your final projects.</p>
</div>
</div>
</body>
</html>
